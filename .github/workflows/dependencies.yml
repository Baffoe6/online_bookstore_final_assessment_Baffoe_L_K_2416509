name: ğŸ“¦ Dependency Updates

on:
  schedule:
    # Check for updates every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of updates to check'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - security
          - major
          - minor
          - patch

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Check for dependency updates
  check-updates:
    name: ğŸ” Check for Updates
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install pip-tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools pip-review

      - name: ğŸ” Check for outdated packages
        run: |
          pip-review --local --auto --verbose || true

      - name: ğŸ“‹ Generate requirements report
        run: |
          pip list --outdated --format=json > outdated-packages.json
          pip list --format=json > current-packages.json

      - name: ğŸ“Š Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            outdated-packages.json
            current-packages.json

  # Security updates check
  security-updates:
    name: ğŸ”’ Security Updates Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit

      - name: ğŸ”’ Check for security vulnerabilities
        run: |
          safety check --json --output security-vulnerabilities.json
          safety check --short-report

      - name: ğŸ”’ Check for security updates
        run: |
          pip-audit --format=json --output=security-updates.json || true
          pip-audit --desc

      - name: ğŸ“Š Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            security-vulnerabilities.json
            security-updates.json

  # Create pull request for updates
  create-pr:
    name: ğŸ”„ Create Update PR
    runs-on: ubuntu-latest
    needs: [check-updates, security-updates]
    if: github.event_name == 'schedule' || github.event.inputs.update_type == 'all'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools

      - name: ğŸ”„ Update dependencies
        run: |
          # Create a new branch for updates
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Update requirements.txt with latest versions
          pip-compile --upgrade requirements.txt
          
          # Check if there are any changes
          if git diff --quiet; then
            echo "No dependency updates available"
            exit 0
          fi

      - name: ğŸ”„ Create pull request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ğŸ“¦ Update dependencies'
          title: 'ğŸ“¦ Automated Dependency Updates'
          body: |
            ## ğŸ“¦ Automated Dependency Updates
            
            This PR contains automated updates to project dependencies.
            
            ### ğŸ” Changes Made:
            - Updated outdated packages to their latest versions
            - Maintained compatibility with existing code
            - Applied security patches where available
            
            ### ğŸ§ª Testing:
            - [ ] Run the test suite
            - [ ] Verify application functionality
            - [ ] Check for any breaking changes
            
            ### ğŸ“‹ Review Checklist:
            - [ ] Review dependency changes
            - [ ] Test the application locally
            - [ ] Check for any security implications
            - [ ] Verify compatibility with production environment
            
            ---
            *This PR was created automatically by the dependency update workflow.*
          branch: automated-dependency-updates
          delete-branch: true

  # Notify about updates
  notify-updates:
    name: ğŸ“¢ Notify Updates
    runs-on: ubuntu-latest
    needs: [check-updates, security-updates, create-pr]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify about dependency updates
        run: |
          echo "ğŸ“¢ Dependency Update Notification"
          echo "================================"
          echo "ğŸ” Update Check: ${{ needs.check-updates.result }}"
          echo "ğŸ”’ Security Check: ${{ needs.security-updates.result }}"
          echo "ğŸ”„ PR Creation: ${{ needs.create-pr.result }}"
          echo "================================"
          
          if [ "${{ needs.create-pr.result }}" == "success" ]; then
            echo "âœ… Pull request created for dependency updates"
          elif [ "${{ needs.create-pr.result }}" == "skipped" ]; then
            echo "â„¹ï¸ No updates available or PR creation skipped"
          else
            echo "âŒ Failed to create pull request for updates"
          fi

  # Dependency audit
  audit-dependencies:
    name: ğŸ“‹ Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install audit tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit pip-licenses

      - name: ğŸ“‹ Audit dependencies
        run: |
          echo "ğŸ“‹ Dependency Audit Report"
          echo "========================="
          
          # List all installed packages
          echo "ğŸ“¦ Installed packages:"
          pip list --format=table
          
          # Check for vulnerabilities
          echo "ğŸ”’ Security vulnerabilities:"
          pip-audit --desc || true
          
          # Check licenses
          echo "ğŸ“„ Package licenses:"
          pip-licenses --format=table || true
          
          # Generate detailed report
          pip-audit --format=json --output=audit-report.json || true
          pip-licenses --format=json --output-file=licenses-report.json || true

      - name: ğŸ“Š Upload audit reports
        uses: actions/upload-artifact@v4
        with:
          name: audit-reports
          path: |
            audit-report.json
            licenses-report.json

  # Dependency summary
  dependency-summary:
    name: ğŸ“Š Dependency Summary
    runs-on: ubuntu-latest
    needs: [check-updates, security-updates, audit-dependencies]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate dependency summary
        run: |
          echo "ğŸ“Š Dependency Management Summary"
          echo "==============================="
          echo "ğŸ” Update Check: ${{ needs.check-updates.result }}"
          echo "ğŸ”’ Security Check: ${{ needs.security-updates.result }}"
          echo "ğŸ“‹ Audit: ${{ needs.audit-dependencies.result }}"
          echo "==============================="
          
          if [ "${{ needs.check-updates.result }}" == "success" ] && 
             [ "${{ needs.security-updates.result }}" == "success" ] && 
             [ "${{ needs.audit-dependencies.result }}" == "success" ]; then
            echo "ğŸ‰ All dependency checks completed successfully!"
          else
            echo "âš ï¸ Some dependency checks failed. Please review the results."
          fi
